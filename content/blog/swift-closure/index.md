---
title: 一个前端学习IOS开发采坑记-swift的闭包
date: "2019-01-16T22:12:03.284Z"
---

## 前言
闭包在swift开发中非常常见。但它却和js中所谓的闭包并不相同。


## 它并不像javascript中的闭包
js中的闭包通常是用于将函数中的私有变量能够供函数外调用的函数，通常称作为闭包。在日常开发中，可以用于创建对象实例等。比如以下
```javascript
function a() {
    let count = 0
    function b() {
        count += 1
    }
    return b
}
a().b()
```


但swift中的闭包是从oc中的block衍生过来的产物，只是换了个名字叫闭包（closure）。首先来看一个典型的闭包。
```swift
outText(callback: { (text: String) in
    let a = text
})

```
作为一个前端在看到这个代码后，肯定会说，这特么不就是一个回调函数嘛。确实，这就是一个回调函数，相当于如下的js代码：
```swift
outText((text) => {
    const a = text
})
```
两个函数功能完全一致，而函数中的回调函数，在swift中就被称为闭包。在swift中，闭包的主要工作之一就是用于作为回调函数来使用。


除了作为回调函数外，另一个常用的功能就是用于实例化对象,代码如下
```swift
let objA = {
    let obj = View()
    return obj
}()
```
对，你没有看错，这特么就是js中的利用匿名函数创建对象，而那个匿名函数在swift中，就被称为是闭包的调用。相同的js如下表示：
```swift
const objA = function() {
    let obj = View()
    return obj
}()
```
swift经常会通过这种方式来定义个控件。

## 闭包有多种简写的代码格式
对于前端开发者来说，swift的闭包在功能使用上并没有太多不同认知，你只需要知道它其实就是一个函数，用于回调和匿名函数即可。然而，swift的闭包变态的是它具有多种不同的格式写法，或者称作为多种简写。以下是一个完整写法和一个最简写法。
```swift
// 完整写法
funcA(callback: { (a:Int,b:Int) -> Int
    return a + b
})
// 最简写
funcA{$0 + $1}
```
是不是有种三观被毁的感觉。这特么还是同一个东西吗？作为一个前端，我一开始看见这种简写形态是懵逼的。难道多写几个代码会死吗？

不过，当你代码看多了的时候，你会发现很多别人的代码或者是一些开源库，在闭包的使用上几乎都是能用简写，绝对不用完整版。所以你只能习惯就好。其实我个人觉得完整版在阅读的时候更加清晰，参数使用更加明确。

当然，完整版和最简写之间是有一连串的省略。以下就是各阶段省略的代码：
```swift
// 完整写法
funcA(callback: { (a:Int,b:Int) -> Int in
    return a + b
})
// 省略闭包中参数的类型
funcA(callback: { (a,b) -> Int in
    return a + b
})
// 省略闭包中参数的挂号
funcA(callback: { a,b -> Int in
    return a + b
})
// 省略返回类型
funcA(callback: { a,b in
    return a + b
})
// 省略return 
funcA(callback:{a,b in 
    a+b
})
// 省略闭包中的参数
funcA(callback:{
    $0+$1
})
// 省略函数中的参数名
funcA({$0 + $1})
// 再把挂号去掉的最简写
funcA{$0 + $1}
```
以上的简写，你可以根据需求使用任何一个阶段的简写。通常，也是在需求允许的情况做到最简单写法。

在以上这些简写中的最后一步简写，涉及到一个闭包的新特性，叫做尾随闭包。
```swift
// 完整写法
funcB(x1: Int, x2: Int, callback:{ (a: Int,b: Int) -> Int in
    return a + b
})

// 省略函数末尾的回调函数的参数，也就是闭包的名称
funcB(x1: Int, x2: Int){ (a: Int,b: Int) in
    return a + b
}
```
以上列子，并没有简写至最简写，目的是告诉你什么是尾随闭包。用前端小伙伴便于理解的话来说，就是如果这个回调函数被放在了函数参数的最后一个，那么我们就可以省略掉参数名称，并且把回调函数的大挂号放到函数外面来表示。

就是由于这样的改变，可能会导致一个前端转过来的同学在阅读代码时看的会有点懵。但只要你知道它的完整版就很容易理解了。

另外，闭包还有一个重要知识点，逃逸闭包。废话少说，看代码
```swift
// 定义一个带有闭包的函数
func a(callback: @escape (a:Int) -> Int) {
    // todo
    ...
    http.get(xxx).then{ data in
        callback(data)
    }
    ...
}

// 调用函数
a(callback: { a -> Int in
    return a + 1
}) 
```
和普通的闭包相比，仅仅在定义闭包的时候多了一个escape。它表示的意义是，当前这个闭包会在本身函数执行完毕后才执行。```http.get()```是表示这是一个请求函数或者是一个延时操作。只有当这个操作执行完成后才会执行闭包。而这样的闭包我们就必须加上escape来修饰。否则编译报错。

用前端的理解就是，这个回调函数是由一个异步请求来触发的，我们就必须加上escape。这个特性在js里当然也是有的。只不过,js根本没有把回调分为异步回调和普通回调。无论哪种回调，写法都一样。

## 总结
ios开发，闭包随处可见。首先，不要被它的各种简写搞懵。其次，把他们当成回调函数，或者匿名函数理解就可以。如果是异步回调，就加上escape修饰。